!function($){Drupal.behaviors.bb={weight:100,attach:function(context,settings){if(0!=$("#tasks-canvas").length){var App=document.App={taskList:null,boardView:null,init:function(){_.extend(App,Backbone.Events),this.parent_id=this.getDeloId()},start:function(){this.taskList=new App.DeloTaskList,this.boardView=new App.DeloTaskBoard({model:this.taskList}),this.taskList.load()},getDeloId:function(){var url=window.location.href,re=/delo\/show\/(\d+)/,match=url.match(re);return match?match[1]:""}};App.DeloTask=Backbone.Model.extend({idAttribute:"delo_id",urlRoot:"/rest/delo",moveToNew:function(){var field=this.get("field_delo_status");field.und[0].tid="4",this.set("field_delo_status",field),this.save()},moveToOngoing:function(){var field=this.get("field_delo_status");field.und[0].tid="5",this.set("field_delo_status",field),this.save()},moveToDone:function(){var field=this.get("field_delo_status");field.und[0].tid="7",this.set("field_delo_status",field),this.save()}}),App.DeloTaskView=Backbone.View.extend({canvas:null,coords:null,dim:null,initialize:function(options,params){this.canvas=params.canvas,this.coords=params.coords,this.dim=params.dim,this.listenTo(this.model,"change",this.render)},render:function(){if(this.canvas&&!this.canvas.getLayerGroup("task"+this.model.id)){var self=this;return this.canvas.drawRect({layer:!0,draggable:!0,groups:["task"+self.model.id],dragGroups:["task"+self.model.id],fillStyle:"green",x:this.coords.x,y:this.coords.y,width:this.dim.w,height:this.dim.h,fromCenter:!1,cornerRadius:5,dblclick:function(layer){Drupal.deloEditTaskDialog(self.model)},dragstart:function(layer){self.start_x=layer.x,self.start_y=layer.y,self.start_section=App.boardView.hitSection(layer.x,layer.y)},drag:function(layer){var section=App.boardView.hitSection(layer.x,layer.y);App.boardView.highlightSection(section)},dragstop:function(layer){var section=App.boardView.hitSection(layer.x,layer.y);if(section==self.start_section){var dx="-="+(layer.x-self.start_x),dy="-="+(layer.y-self.start_y);$(this).animateLayerGroup("task"+self.model.id,{x:dx,y:dy},500)}else self.coords.x=layer.x,self.coords.y=layer.y,self.moveToSection(section);App.boardView.highlightSection(0)},dragcancel:function(layer){var dx="-="+(layer.x-self.start_x),dy="-="+(layer.y-self.start_y);$(this).animateLayerGroup("task"+self.model.id,{x:dx,y:dy},500),App.boardView.highlightSection(0)}}),this.canvas.drawText({layer:!0,draggable:!0,groups:["task"+self.model.id],dragGroups:["task"+self.model.id],fillStyle:"white",fontSize:10,fontFamily:"Arial",x:this.coords.x+6,y:this.coords.y+5,fromCenter:!1,text:this.model.get("title")}),this}},moveToSection:function(section){switch(section){case 1:this.model.moveToNew();break;case 2:this.model.moveToOngoing();break;case 3:this.model.moveToDone()}},ellipsis:function(text,width){}}),App.DeloTaskList=Backbone.Collection.extend({model:App.DeloTask,url:"/rest/delo",statusMap:{7:"Выполнено",5:"Выполняется",4:"Новое дело",8:"Отменено",6:"Приостановлено"},initialize:function(){this.on("destroy",function(model){console.log("collection got destroy for model"),this.remove(model),App.trigger("task:destroy")})},load:function(){this.fetch({success:function(){App.trigger("tasklist:change")}})},getSubtasks:function(){var subtasks=[];return this.each(function(task){task.get("parent_id")==App.parent_id&&subtasks.push(task)}),subtasks},getNew:function(){return this.filter(function(model){var status=model.get("field_delo_status").und[0].tid;return"4"==status})},getInProgress:function(){return this.filter(function(model){var status=model.get("field_delo_status").und[0].tid;return"5"==status})},getDone:function(){return this.filter(function(model){var status=model.get("field_delo_status").und[0].tid;return"7"==status})}}),App.DeloTaskBoard=Backbone.View.extend({views:[],pad:5,pad_b:4,pad_t:5,pad_h:10,canvas:null,initialize:function(){this.canvas=$("#tasks-canvas"),this.listenTo(App,"tasklist:change",this.render),this.listenTo(App,"task:destroy",function(){console.log("board view got task:destroy"),this.render()})},render:function(){if(this.canvas){this.canvas.attr("width",parseInt(this.canvas.css("width"))),this.canvas.attr("height",parseInt(this.canvas.css("height"))),this.canvas.clearCanvas(),this.drawGrid(),this.drawTitles();var dx=this.canvas.width()-2*this.pad-2*this.pad_b,dx2=(this.canvas.height()-2*this.pad-2*this.pad_b,dx/3),width=dx2/2,height=20,self=this,i=[0,0,0];return _.each(this.model.getSubtasks(),function(task){var status=task.get("field_delo_status").und[0].tid,map={4:0,5:1,7:2},k=map[status];if(void 0!==k){var x=self.pad+self.pad_b+self.pad_t+k*dx2,y=self.pad+self.pad_b+self.pad_t+self.pad_h+height+i[k]*(height+self.pad_h);i[k]++;var view=self.views[task.id]=self.views[task.id]||new App.DeloTaskView({model:task},{canvas:self.canvas,coords:{x:x,y:y},dim:{w:width,h:height}});view.render()}}),this}},getDeloId:function(){var url=window.location.href,re=/delo\/show\/(\d+)/,match=url.match(re);return match?match[1]:""},drawGrid:function(){var x=this.pad,y=this.pad,dx=this.canvas.width()-this.pad-this.pad,dy=this.canvas.height()-this.pad-this.pad;this.canvas.drawRect({layer:!0,strokeStyle:"black",strokeWidth:1,fillStyle:"white",x:x,y:y,width:dx,height:dy,fromCenter:!1}),x+=this.pad_b,y+=this.pad_b,dx-=2*this.pad_b,dy-=2*this.pad_b;var dx2=dx/3;this.canvas.drawRect({layer:!0,name:"section1",strokeStyle:"black",strokeWidth:1,x:x,y:y,width:dx2,height:dy,fromCenter:!1}),this.canvas.drawRect({layer:!0,name:"section2",strokeStyle:"black",strokeWidth:1,x:x+dx2,y:y,width:dx2,height:dy,fromCenter:!1}),this.canvas.drawRect({layer:!0,name:"section3",strokeStyle:"black",strokeWidth:1,x:x+dx2+dx2,y:y,width:dx2,height:dy,fromCenter:!1})},drawTitles:function(){var dx=this.canvas.width()-this.pad-this.pad,dx2=dx/3,x=this.pad+this.pad_b+this.pad_t,y=this.pad+this.pad_b+this.pad_t;this.canvas.drawText({layer:!0,fillStyle:"black",fontSize:18,fontFamily:"Arial",x:x,y:y,fromCenter:!1,text:"Новые"}),x+=dx2,this.canvas.drawText({layer:!0,fillStyle:"black",fontSize:18,fontFamily:"Arial",x:x,y:y,fromCenter:!1,text:"В процессе"}),x+=dx2,this.canvas.drawText({layer:!0,fillStyle:"black",fontSize:18,fontFamily:"Arial",x:x,y:y,fromCenter:!1,text:"Законченые"})},drawBackground:function(x1,y1,x2,y2){var size=60,minSize=30,maxSize=100,speedX=1,speedY=1,speedSize=1,sizeGap=10,self=this;this.canvas.drawEllipse({layer:!0,name:"bg",fillStyle:function(layer){return self.canvas.createGradient({x1:layer.x+layer.width/2,y1:layer.y+layer.height/2,x2:layer.x+layer.width/2,y2:layer.y+layer.height/2,r1:0,r2:layer.width,c1:"#eeeeee",c2:"#aaaaaa"})},strokeStyle:"#dddddd",x:x1,y:y1,width:size,height:size,fromCenter:!1});var layer=self.canvas.getLayer("bg"),move1px=function(){0==sizeGap?(1==speedSize?size>=maxSize?speedSize=-1:size++:size<=minSize?speedSize=1:size--,sizeGap=10):sizeGap--;var newX,newY;speedX>0?layer.x+size+1>=x2?(speedX=-1,newX=layer.x-1):newX=layer.x+1:layer.x-1<=x1?(newX=layer.x+1,speedX=1):newX=layer.x-1,speedY>0?layer.y+size+1>=y2?(speedY=-1,newY=layer.y-1):newY=layer.y+1:layer.y-1<=y1?(newY=layer.y+1,speedY=1):newY=layer.y-1,self.canvas.setLayer("bg",{x:newX,y:newY,width:size,height:size}),self.canvas.drawLayers()},step=function(timestamp){move1px(),requestAnimationFrame(step)};requestAnimationFrame(step)},hitSection:function(x,y){var s1=this.canvas.getLayer("section1"),s2=this.canvas.getLayer("section2"),s3=this.canvas.getLayer("section3");return x>s1.x&&x<s2.x&&y>s1.y&&y<s1.y+s1.height?1:x>s2.x&&x<s3.x&&y>s1.y&&y<s1.y+s1.height?2:x>s3.x&&x<s3.x+s3.width&&y>s1.y&&y<s1.y+s1.height?3:0},highlightSection:function(section){(this.highlightedSection&&this.highlightedSection!=section||0==section)&&this.canvas.setLayer("section"+this.highlightedSection,{strokeStyle:"black"}),0!=section&&(this.highlightedSection=section,this.canvas.setLayer("section"+section,{strokeStyle:"blue"}),this.canvas.moveLayer("section"+section,3))}}),App.init(),App.start()}}}}(jQuery),function($){Drupal.behaviors.board={attach:function(context,settings){},detach:function(context,settings){}}}(jQuery),function(){!function($){return Drupal.behaviors.expert={attach:function(context,settings){var Advice,Answer,Expert,ExpertBase,Question;return ExpertBase=function(){function ExpertBase(){}return ExpertBase.prototype.build=function(){},ExpertBase}(),Question=function(){function Question(id,question){this.id=id,this.question=question}return Question.prototype.getQuestion=function(){return this.question},Question}(),Answer=function(){function Answer(id,answer){this.id=id,this.answer=answer}return Answer.prototype.getAnswer=function(){return this.answer},Answer}(),Advice=function(){function Advice(id,advice){this.id=id,this.advice=advice}return Advice.prototype.getAdvice=function(){return this.advice},Advice}(),Expert=function(){function Expert(base){this.base=base,this.answers=[],this.currentQuestion=null}return Expert.prototype.nextQuestion=function(){return null},Expert}()}}}(jQuery)}.call(this),function($){}(jQuery),function(){!function($){return Drupal.behaviors.notes={attach:function(context,settings){var Note,Notepad;if(context===document)return Note=function(){function Note(title,text){this.title=null!=title?title:"(без названия)",this.text=null!=text?text:""}return Note.prototype.setText=function(text){this.text=text},Note.prototype.getText=function(){return this.text},Note.prototype.setTitle=function(title){this.title=title},Note.prototype.getTitle=function(){return this.title},Note}(),Notepad=function(){function Notepad(){this.notes=[]}return Notepad.prototype.add=function(item){if(item instanceof Note)return this.notes.push(item),this.save();throw Exception("wrong Note is being added to Notepad")},Notepad.prototype.remove=function(item){var i;if(i=this.notes.indexOf(item),i!==-1)return this.notes.splice(i,1)},Notepad.prototype.save=function(){var i,j,len1,notes,ref,results;for(localStorage.setItem("deloNotepadNo",this.notes.length),ref=this.notes,results=[],i=j=0,len1=ref.length;j<len1;i=++j)notes=ref[i],results.push(localStorage.setItem("deloNotepadItem"+i,JSON.stringify(this.notes[i])));return results},Notepad.prototype.load=function(){var i,item,j,len,ref;if(this.notes=[],len=localStorage.getItem("deloNotepadNo"),null!=len)for(this.activeItem=0,i=j=0,ref=len-1;0<=ref?j<=ref:j>=ref;i=0<=ref?++j:--j)item=JSON.parse(localStorage.getItem("deloNotepadItem"+i)),this.notes.push(new Note(item.title,item.text));return this.notes.length},Notepad.prototype.count=function(){return this.notes.length},Notepad.prototype.draw=function(){if(console.log("drawing notes:"),console.log(this.notes),null==this.field)return this.openNotes=function(){return this.field.removeClass("notepad-min"),this.field.unbind("click"),this.closeBtn.show(),this.notes_container.show()},this.closeNotes=function(){return this.field.addClass("notepad-min"),this.field.bind("click",function(_this){return function(){return _this.openNotes()}}(this)),this.closeBtn.hide(),this.notes_container.hide()},this.switchNotes=function(val){return this.activeItem=val,this.textarea.val(this.notes[val].getText()),this.textarea.focus()},this.updateNote=function(item){return this.notes[item].setText(this.textarea.val()),localStorage.setItem("deloNotepadItem"+item,JSON.stringify(this.notes[item]))},this.field=$("<div></div>"),this.field.addClass("notepad"),$("body").append(this.field),this.closeBtn=$("<div></div>").addClass("notepad-close-btn"),this.closeBtn.attr("title","Закрыть"),this.closeBtn.bind("click",function(_this){return function(e){return e.stopPropagation(),_this.closeNotes()}}(this)),this.field.append(this.closeBtn),this.notes_container=$("<div></div>").addClass("notepad-notes"),this.field.append(this.notes_container),this.select=$("<select></select>"),_.each(this.notes,function(_this){return function(note,index){if(null!=note)return _this.select.append("<option value="+index+">"+note.getTitle()+"</option>")}}(this)),this.notes_container.append(this.select),this.select.bind("change",function(_this){return function(){var item;return item=_this.select.find("option:selected").val(),_this.switchNotes(item)}}(this)),this.textarea=$("<textarea></textarea>"),this.textarea.bind("input",function(_this){return function(){return _this.updateNote(_this.activeItem)}}(this)),this.notes_container.append(this.textarea),null==this.activeItem&&(this.activeItem=0),this.switchNotes(this.activeItem)},Notepad}()}}}(jQuery)}.call(this),function($){Drupal.behaviors.new_task_popup={weight:0,attach:function(context,settings){function validateFields(){var submit=$("#new-task-submit");if(submit){var title=$("#new-task-title"),description=$("#new-task-description");title&&description&&(""===$.trim(title.val())||""===$.trim(description.val())?submit.attr("disabled","disabled"):submit.removeAttr("disabled"))}}$("#new-dialog").dialog({autoOpen:!1,width:"auto",height:"auto",appendTo:"#main-delo-open",closeOnEscape:!0,modal:!0,resizable:!1,draggable:!0}),$("#new-task-opener").click(function(){validateFields(),$("#new-dialog").dialog("open")}),$("#new-task-title").keyup(function(){validateFields()}),$("#new-task-description").keyup(function(){validateFields()}),$("#new-task-cancel").click(function(e){e.preventDefault(),$("#new-dialog").dialog("close")})}},Drupal.behaviors.edit_task_popup={weight:10,attach:function(context,settings){Drupal.deloEditTaskDialog=function(task){var task_title=task.get("title"),task_description=task.get("description"),task_id=task.get("id");$("#edit-dialog").remove();var editDialogTmpl=_.template($("#edit-task-popup-template").html()),editDialog=editDialogTmpl({title:task_title,description:task_description,statuses:document.App.taskList.statusMap});$("#tasks-canvas").append(editDialog);var saveButton=$("#edit-dialog input[name='task-edit-save']");saveButton.click(function(){({id:task_id,title:$("#task-edit-title").val(),description:$("#task-edit-descr").val()});task.set({title:$("#task-edit-title").val(),description:$("#task-edit-descr").val()}),task.save(),$("#edit-dialog").dialog("close")});var cancelButton=$("#edit-dialog input[name='task-edit-cancel']");cancelButton.click(function(){$("#edit-dialog").dialog("close")});var deleteButton=$("#edit-dialog input[name='task-edit-delete']");deleteButton.click(function(){confirm("Вы уверены?")&&(task.destroy(),$("#edit-dialog").dialog("close"))}),$("#edit-dialog").dialog({autoOpen:!0,width:"auto",height:"auto",closeOnEscape:!0,modal:!0,resizable:!1,draggable:!0})}}}}(jQuery),function($){Drupal.behaviors.shelf={attach:function(context,settings){if(context===document&&0!==$("#shelf-svg").length){var draw=SVG("shelf-svg").size(300,200);draw.rect(10,100).attr({fill:"black"}).x(10).y(10),draw.rect(300,10).attr({fill:"black"}).y(90),draw.rect(10,100).attr({fill:"black"}).x(280).y(10),$.getJSON("/rest/delo/shelf",function(data){var x=30;_.each(data,function(delo){draw.rect(20,80).attr({stroke:"black",fill:"lightgray",title:delo.title}).x(x).linkTo("/delo/take-from-shelf/"+delo.delo_id),draw.text(delo.delo_id).x(x)})})}}}}(jQuery),function($){Drupal.behaviors.solo={attach:function(context,settings){$("#svg-main-rect").bind("mouseenter",function(){$(this).attr("fill","yellow")}).bind("mouseleave",function(){$(this).attr("fill","lightgray")})}}}(jQuery),function(){!function($){return Drupal.behaviors.tea={attach:function(context,settings){var func;return func=function(go){return console.log("hello")}}}}(jQuery)}.call(this);